name: Japanese Writing Quality Check
on:
  pull_request:
    paths:
      - '**.tex'

jobs:
  textlint:
    runs-on: ubuntu-latest
    container: ghcr.io/smkwlab/texlive-ja-textlint:2025e

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run textlint on TeX files
        id: textlint
        continue-on-error: true
        run: |
          # PR ã§å¤‰æ›´ã•ã‚ŒãŸ .tex ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.tex$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Checking files: $CHANGED_FILES"
            textlint $CHANGED_FILES > textlint-result.txt 2>&1
            TEXTLINT_EXIT_CODE=$?
            cat textlint-result.txt

            # textlint ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ã§å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
            if [ $TEXTLINT_EXIT_CODE -ne 0 ]; then
              echo "has_issues=true" >> $GITHUB_OUTPUT
            else
              echo "has_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No .tex files changed in this PR"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with textlint results
        if: steps.textlint.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const textlintResult = fs.readFileSync('textlint-result.txt', 'utf8');

            const body = `ğŸ“ **textlint ã«ã‚ˆã‚‹æ—¥æœ¬èªå“è³ªãƒã‚§ãƒƒã‚¯çµæœ**

æ–‡ç« ã®æ”¹å–„ææ¡ˆãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®æŒ‡æ‘˜ã‚’ç¢ºèªã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

\`\`\`
${textlintResult}
\`\`\`

**æ³¨æ„**: ã“ã‚Œã¯è­¦å‘Šã§ã™ã€‚CI ã¯æˆåŠŸã—ã¦ã„ã¾ã™ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
