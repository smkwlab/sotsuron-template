name: Prevent Draft Branch Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - review-branch

jobs:
  check-draft-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check if branch is draft
        id: check-draft
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # draftç³»ãƒ–ãƒ©ãƒ³ãƒã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if [[ "$BRANCH_NAME" =~ ^[0-9]+(st|nd|rd|th)-draft$ ]] || \
             [[ "$BRANCH_NAME" =~ ^abstract-[0-9]+(st|nd|rd|th)$ ]] || \
             [[ "$BRANCH_NAME" =~ ^gaiyou-[0-9]+(st|nd|rd|th)$ ]]; then
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "draft_type=main" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" =~ ^0th-draft$ ]]; then
            echo "is_draft=true" >> $GITHUB_OUTPUT  
            echo "draft_type=initial" >> $GITHUB_OUTPUT
          else
            echo "is_draft=false" >> $GITHUB_OUTPUT
          fi

      - name: Block draft branch merge
        if: steps.check-draft.outputs.is_draft == 'true'
        run: |
          echo "::error::âŒ æ·»å‰Šç”¨ãƒ–ãƒ©ãƒ³ãƒã¯ãƒãƒ¼ã‚¸ç¦æ­¢ã§ã™"
          echo "::error::ğŸ“ ãƒ–ãƒ©ãƒ³ãƒå: ${{ github.head_ref }}"
          echo "::error::ğŸ¯ ã“ã®PRã¯æ•™å“¡ã«ã‚ˆã‚‹æ·»å‰Šãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã§ã™"
          echo "::error::âœ… å­¦ç”Ÿï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†å¾Œã«PRã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„"
          echo "::error::ğŸ‘¨â€ğŸ« æ•™å“¡ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿å®Ÿæ–½ã—ã€ãƒãƒ¼ã‚¸ã¯è¡Œã‚ãªã„ã§ãã ã•ã„"
          
          if [[ "${{ steps.check-draft.outputs.draft_type }}" == "initial" ]]; then
            echo "::error::â„¹ï¸  åˆæœŸæå‡ºç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™ï¼ˆ0th-draftï¼‰"
          else
            echo "::error::â„¹ï¸  æ·»å‰Šä¾é ¼ç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™"
          fi
          
          echo ""
          echo "::notice::ğŸ“– è©³ç´°ãªè«–æ–‡åŸ·ç­†ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦ã¯ README.md ã‚’ã”ç¢ºèªãã ã•ã„"
          exit 1

      - name: Success - Non-draft branch
        if: steps.check-draft.outputs.is_draft == 'false'
        run: |
          echo "âœ… é€šå¸¸ã®ãƒ–ãƒ©ãƒ³ãƒã§ã™ - ãƒãƒ¼ã‚¸å¯èƒ½"
          echo "ğŸ“ ãƒ–ãƒ©ãƒ³ãƒå: ${{ github.head_ref }}"