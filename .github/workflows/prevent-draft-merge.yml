name: âœ‹ èª¤ãƒžãƒ¼ã‚¸é˜²æ­¢å‡¦ç†ï¼ˆã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¤±æ•—ã—ã¾ã™ã€‚ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚ï¼‰

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - review-branch

jobs:
  check-draft-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check if branch is draft
        id: check-draft
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³åº§ã«åœæ­¢
          
          BRANCH_NAME="${{ github.head_ref }}"
          echo "::debug::Starting branch analysis"
          echo "::debug::Branch name: $BRANCH_NAME"
          echo "::debug::Current HEAD: $(git rev-parse HEAD)"
          
          # Git ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹ç¢ºèª
          if ! git rev-parse --git-dir >/dev/null 2>&1; then
            echo "::error::Git repository not found"
            exit 1
          fi
          
          # final-* ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯
          echo "::debug::Checking for final-* tags..."
          TAGS_AT_HEAD=""
          if TAGS_AT_HEAD=$(git tag --points-at HEAD 2>/dev/null); then
            echo "::debug::Tags at HEAD: ${TAGS_AT_HEAD:-'none'}"
            
            if echo "$TAGS_AT_HEAD" | grep -q "^final-"; then
              FINAL_TAG=$(echo "$TAGS_AT_HEAD" | grep "^final-" | head -1)
              echo "is_draft=false" >> $GITHUB_OUTPUT
              echo "is_final_submission=true" >> $GITHUB_OUTPUT
              echo "final_tag=$FINAL_TAG" >> $GITHUB_OUTPUT
              echo "âœ… Final submission detected - merge allowed"
              echo "::notice::Final submission tag: $FINAL_TAG"
              exit 0
            fi
          else
            echo "::debug::No tags found at HEAD (this is normal for draft branches)"
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒåæ¤œè¨¼ï¼ˆç‰¹æ®Šæ–‡å­—å¯¾å¿œï¼‰
          if [[ -z "$BRANCH_NAME" ]]; then
            echo "::error::Branch name is empty"
            exit 1
          fi
          
          # draftç³»ãƒ–ãƒ©ãƒ³ãƒã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          echo "::debug::Checking draft branch patterns..."
          
          # ãƒ¡ã‚¤ãƒ³æ·»å‰Šãƒ–ãƒ©ãƒ³ãƒï¼ˆ1st-draft, 2nd-draftç­‰ï¼‰
          if [[ "$BRANCH_NAME" =~ ^[0-9]+(st|nd|rd|th)-draft$ ]]; then
            echo "::debug::Matched main draft pattern: $BRANCH_NAME"
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "draft_type=main" >> $GITHUB_OUTPUT
          # æ¦‚è¦æ·»å‰Šãƒ–ãƒ©ãƒ³ãƒï¼ˆabstract-1st, gaiyou-1stç­‰ï¼‰
          elif [[ "$BRANCH_NAME" =~ ^(abstract|gaiyou)-[0-9]+(st|nd|rd|th)$ ]]; then
            echo "::debug::Matched abstract draft pattern: $BRANCH_NAME"
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "draft_type=abstract" >> $GITHUB_OUTPUT
          # åˆæœŸæå‡ºãƒ–ãƒ©ãƒ³ãƒï¼ˆ0th-draftï¼‰
          elif [[ "$BRANCH_NAME" =~ ^0th-draft$ ]]; then
            echo "::debug::Matched initial draft pattern: $BRANCH_NAME"
            echo "is_draft=true" >> $GITHUB_OUTPUT  
            echo "draft_type=initial" >> $GITHUB_OUTPUT
          # é€šå¸¸ãƒ–ãƒ©ãƒ³ãƒ
          else
            echo "::debug::No draft pattern matched - regular branch"
            echo "is_draft=false" >> $GITHUB_OUTPUT
            echo "draft_type=none" >> $GITHUB_OUTPUT
          fi
          
          echo "::debug::Branch analysis completed"

      - name: Block draft branch merge
        if: steps.check-draft.outputs.is_draft == 'true'
        run: |
          DRAFT_TYPE="${{ steps.check-draft.outputs.draft_type }}"
          BRANCH_NAME="${{ github.head_ref }}"
          
          echo "::error::âŒ æ·»å‰Šç”¨ãƒ–ãƒ©ãƒ³ãƒã¯ãƒžãƒ¼ã‚¸ç¦æ­¢ã§ã™"
          echo "::error::ðŸ“ ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
          echo "::error::ðŸŽ¯ ã“ã®PRã¯æ•™å“¡ã«ã‚ˆã‚‹æ·»å‰Šãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã§ã™"
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—åˆ¥ã®è©³ç´°èª¬æ˜Ž
          case "$DRAFT_TYPE" in
            "initial")
              echo "::error::â„¹ï¸  åˆæœŸæå‡ºç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™ï¼ˆ0th-draftï¼‰"
              ;;
            "main")
              echo "::error::â„¹ï¸  æ·»å‰Šç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™ï¼ˆ1st-draft, 2nd-draftç­‰ï¼‰"
              ;;
            "abstract")
              echo "::error::â„¹ï¸  æ¦‚è¦æ·»å‰Šç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™ï¼ˆabstract-1st, gaiyou-1stç­‰ï¼‰"
              echo "::error::ðŸ“‹ ç›®çš„ï¼šè«–æ–‡æ¦‚è¦ã®æ”¹å–„ãƒ»å®Œæˆåº¦å‘ä¸Š"
              ;;
            *)
              echo "::error::â„¹ï¸  æ·»å‰Šä¾é ¼ç”¨ãƒ–ãƒ©ãƒ³ãƒã§ã™"
              ;;
          esac
          
          echo ""
          echo "::notice::ðŸ‘¨â€ðŸŽ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†å¾Œã«PRã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„"
          echo "::notice::ðŸ“– è©³ç´°ï¼šREADME.md ã®ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          
          echo "::debug::Branch type: $DRAFT_TYPE, Action: Block merge"

          # GitHub Summaryã«å­¦ç”Ÿå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… æ­£å¸¸å‹•ä½œï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨PRã§ã™

          ã“ã®PRã¯ **æ•™å“¡ã«ã‚ˆã‚‹æ·»å‰Šãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨** ã§ã™ã€‚
          
          **ðŸ“ å­¦ç”Ÿã®æ–¹ã¸**
          - ã“ã®ã€Œå¤±æ•—ã€è¡¨ç¤ºã¯æ­£å¸¸ã§ã™ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
          - æ•™å“¡ã‹ã‚‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠå¾…ã¡ãã ã•ã„
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œå®Œäº†å¾Œã€PRã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„
          - æ¬¡ã®ä½œæ¥­ã¯æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã§è¡Œã£ã¦ãã ã•ã„
          
          **ðŸŽ¯ ç›®çš„**
          - èª¤ã£ã¦ãƒžãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã‚’é˜²ãå®‰å…¨æ©Ÿèƒ½
          - é©åˆ‡ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
          EOF
          
          exit 1

      - name: Success - Non-draft branch
        if: steps.check-draft.outputs.is_draft == 'false'
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          IS_FINAL="${{ steps.check-draft.outputs.is_final_submission }}"
          
          if [[ "$IS_FINAL" == "true" ]]; then
            FINAL_TAG="${{ steps.check-draft.outputs.final_tag }}"
            echo "ðŸŽ“ æœ€çµ‚æå‡ºãƒ–ãƒ©ãƒ³ãƒã§ã™ - ãƒžãƒ¼ã‚¸è¨±å¯"
            echo "ðŸ“ ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
            echo "ðŸ·ï¸  æœ€çµ‚æå‡ºã‚¿ã‚°: $FINAL_TAG"
            echo "::notice::æœ€çµ‚æå‡ºãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
          else
            echo "âœ… é€šå¸¸ã®ãƒ–ãƒ©ãƒ³ãƒã§ã™ - ãƒžãƒ¼ã‚¸å¯èƒ½"
            echo "ðŸ“ ãƒ–ãƒ©ãƒ³ãƒå: $BRANCH_NAME"
            echo "::notice::é€šå¸¸ã®ãƒ–ãƒ©ãƒ³ãƒã®ãŸã‚ã€ãƒžãƒ¼ã‚¸åˆ¶é™ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
          
          echo "::debug::Branch check passed - merge allowed"
