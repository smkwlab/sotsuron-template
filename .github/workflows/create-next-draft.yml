---
name: Create Next Draft Branch

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  create-next-branch:
    runs-on: ubuntu-latest

    # draftç³»ã¾ãŸã¯abstractç³»ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®PRã®ã¿å®Ÿè¡Œ
    if: |
      contains(github.head_ref, 'draft') ||
      contains(github.head_ref, 'abstract-')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Determine next branch name
        id: next-branch
        run: |
          CURRENT_BRANCH="${{ github.head_ref }}"

          # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§æ¬¡ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’æ±ºå®š
          if [[ "$CURRENT_BRANCH" =~ ^([0-9]+)(st|nd|rd|th)-draft$ ]]; then
            # è«–æ–‡æœ¬ä½“ã®ãƒ–ãƒ©ãƒ³ãƒ (ä¾‹: 1st-draft, 2nd-draft, etc.)
            CURRENT_NUM="${BASH_REMATCH[1]}"
            NEXT_NUM=$((CURRENT_NUM + 1))

            # åºæ•°ã®æ¥å°¾è¾ã‚’æ±ºå®š
            case $NEXT_NUM in
              1|21) SUFFIX="st" ;;
              2|22) SUFFIX="nd" ;;
              3|23) SUFFIX="rd" ;;
              *) SUFFIX="th" ;;
            esac

            NEXT_BRANCH="${NEXT_NUM}${SUFFIX}-draft"

          elif [[ "$CURRENT_BRANCH" =~ ^abstract-([0-9]+)(st|nd|rd|th)$ ]]; then
            # æ¦‚è¦ã®ãƒ–ãƒ©ãƒ³ãƒ (ä¾‹: abstract-1st, abstract-2nd, etc.)
            CURRENT_NUM="${BASH_REMATCH[1]}"
            NEXT_NUM=$((CURRENT_NUM + 1))

            # åºæ•°ã®æ¥å°¾è¾ã‚’æ±ºå®š
            case $NEXT_NUM in
              1|21) SUFFIX="st" ;;
              2|22) SUFFIX="nd" ;;
              3|23) SUFFIX="rd" ;;
              *) SUFFIX="th" ;;
            esac

            NEXT_BRANCH="abstract-${NEXT_NUM}${SUFFIX}"

          elif [ "$CURRENT_BRANCH" = "0th-draft" ]; then
            # ç‰¹æ®Šã‚±ãƒ¼ã‚¹: 0th-draft â†’ 1st-draft
            NEXT_BRANCH="1st-draft"

          else
            echo "Unexpected branch name pattern: $CURRENT_BRANCH"
            exit 0
          fi

          echo "next_branch=$NEXT_BRANCH" >> $GITHUB_OUTPUT
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

      - name: Check if next branch already exists
        id: check-branch
        run: |
          NEXT_BRANCH="${{ steps.next-branch.outputs.next_branch }}"

          if [ -z "$NEXT_BRANCH" ]; then
            echo "exists=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          if git show-ref --verify --quiet "refs/remotes/origin/$NEXT_BRANCH"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create next draft branch
        if: steps.check-branch.outputs.exists == 'false'
        run: |
          CURRENT_BRANCH="${{ steps.next-branch.outputs.current_branch }}"
          NEXT_BRANCH="${{ steps.next-branch.outputs.next_branch }}"

          # å…¨ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¯ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ™ãƒ¼ã‚¹ã«ä½œæˆ
          BASE_BRANCH="origin/$CURRENT_BRANCH"

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b "$NEXT_BRANCH" "$BASE_BRANCH"
          git push -u origin "$NEXT_BRANCH"

          echo "âœ… Created $NEXT_BRANCH based on $CURRENT_BRANCH"

      # Simplified: Students manually merge abstract into draft branches if needed
      # No automatic base branch updates

      - name: Add comment to PR
        if: steps.check-branch.outputs.exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_BRANCH="${{ steps.next-branch.outputs.next_branch }}"

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ğŸŒ¿ **æ¬¡ç¨¿ç”¨ãƒ–ãƒ©ãƒ³ãƒã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸ**: \`$NEXT_BRANCH\`"

      - name: Add notice if branch exists
        if: steps.check-branch.outputs.exists == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_BRANCH="${{ steps.next-branch.outputs.next_branch }}"

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "â„¹ï¸ **æ¬¡ç¨¿ç”¨ãƒ–ãƒ©ãƒ³ãƒã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™**: \`$NEXT_BRANCH\`"
